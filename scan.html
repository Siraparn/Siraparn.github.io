<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odoo QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        #reader { width: 100%; max-width: 500px; margin: 0 auto; border-radius: 10px; overflow: hidden; }
        .console-log { background: #212529; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 5px; height: 150px; overflow-y: scroll; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <h3 class="mb-3">üì∑ Scan QR to Odoo</h3>
            
            <div id="reader" class="mb-3 shadow"></div>

            <div class="card mb-3 text-start">
                <div class="card-body">
                    <label class="form-label fw-bold">Odoo Endpoint:</label>
                    <input type="text" id="odooUrl" class="form-control form-control-sm" value="https://your-odoo-url.com/api/receive_qr" placeholder="https://...">
                    <small class="text-muted">‡πÄ‡∏ä‡πà‡∏ô /web/dataset/call_kw ‡∏´‡∏£‡∏∑‡∏≠ Custom Controller</small>
                </div>
            </div>

            <div class="card mb-3 text-start">
                <div class="card-header bg-primary text-white">Scan Result</div>
                <div class="card-body">
                    <h5 class="card-title" id="scanResultText">Waiting for scan...</h5>
                    <p class="card-text text-muted" id="apiStatus">API Status: Idle</p>
                </div>
            </div>

            <div class="text-start">
                <label class="fw-bold">Logs:</label>
                <div id="appConsole" class="console-log">System ready...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    // --- Configuration ---
    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á Beep ‡∏ï‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    const scanSuccessAudio = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'); 

    function log(message) {
        const consoleDiv = document.getElementById('appConsole');
        const time = new Date().toLocaleTimeString();
        consoleDiv.innerHTML += `<div>[${time}] ${message}</div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    async function sendToOdoo(qrData) {
        const url = document.getElementById('odooUrl').value;
        const statusElem = document.getElementById('apiStatus');
        
        statusElem.innerHTML = `API Status: <span class="text-warning">Sending...</span>`;
        log(`Sending data to Odoo: ${qrData}`);

        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Odoo (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏≤‡∏° Controller ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        // ‡∏Å‡∏£‡∏ì‡∏µ Odoo 10-16+ ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON-RPC ‡∏´‡∏£‡∏∑‡∏≠ REST ‡∏ñ‡∏≤‡πâ‡∏•‡∏á Module ‡πÄ‡∏™‡∏£‡∏¥‡∏°
        const payload = {
            jsonrpc: "2.0",
            method: "call",
            params: {
                qr_code: qrData,
                device_info: navigator.userAgent
                // ‡πÉ‡∏™‡πà authentication token ‡∏´‡∏£‡∏∑‡∏≠ db name ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            },
            id: Math.floor(Math.random() * 1000)
        };

        try {
            // ** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç **: Browser ‡∏à‡∏∞ Block ‡∏ñ‡πâ‡∏≤ Odoo Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î CORS
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Authorization': 'Bearer YOUR_TOKEN' // ‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ä‡πâ Token
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const data = await response.json();
            
            if (data.error) {
                 throw new Error(data.error.data.message || "Odoo Error");
            }

            statusElem.innerHTML = `API Status: <span class="text-success">Success!</span>`;
            log(`Odoo Response: ${JSON.stringify(data.result)}`);
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");

        } catch (error) {
            console.error(error);
            statusElem.innerHTML = `API Status: <span class="text-danger">Failed</span>`;
            log(`Error: ${error.message}`);
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Developer
            if(error.message.includes("Failed to fetch")) {
                log(`‚ö†Ô∏è CORS Error? ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Odoo Server ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÄ‡∏ó‡∏™‡∏ú‡πà‡∏≤‡∏ô Proxy`);
            }
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏¥‡∏î
        scanSuccessAudio.play();
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        document.getElementById('scanResultText').innerText = decodedText;
        log(`QR Found: ${decodedText}`);

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á API ‡∏£‡∏±‡∏ß‡πÜ
        html5QrcodeScanner.pause();

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Odoo
        sendToOdoo(decodedText).then(() => {
            // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Reset ‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)
            setTimeout(() => {
                document.getElementById('apiStatus').innerText = "API Status: Ready for next";
                html5QrcodeScanner.resume();
            }, 3000);
        });
    }

    function onScanFailure(error) {
        // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏´‡∏≤‡∏°‡∏∏‡∏° QR ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á log ‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏£‡∏Å)
    }

    // --- Initialize Scanner ---
    // fps: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ü‡∏£‡∏°‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ, qrbox: ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡πÇ‡∏ü‡∏Å‡∏±‡∏™
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { fps: 10, qrbox: { width: 250, height: 250 } },
        /* verbose= */ false
    );
    
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>

</body>
</html>
