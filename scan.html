<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odoo Scan & Stop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        /* ‡∏à‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        #reader { width: 100%; max-width: 500px; margin: 0 auto; background: #000; border-radius: 8px; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
        #resultSection { display: none; }
        
        /* Animation icon */
        .status-icon { font-size: 3rem; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            
            <h4 class="text-center mb-4 fw-bold text-primary">üì¶ Odoo Scanner</h4>

            <div class="mb-3">
                <label class="form-label small text-muted">API Endpoint:</label>
                <input type="text" id="odooUrl" class="form-control form-control-sm" 
                       value="http://localhost:8069/api/scan_qr" placeholder="http://...">
            </div>

            <div id="cameraSection">
                <div id="reader"></div>
                <div class="text-center mt-2 text-muted small">‡∏ß‡∏≤‡∏á QR Code ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö</div>
            </div>

            <div id="resultSection" class="card shadow-sm text-center p-4">
                
                <div id="loadingState">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Odoo...</h5>
                    <p class="text-muted" id="scannedDataShow">...</p>
                </div>

                <div id="finalState" style="display:none;">
                    <div id="statusIcon" class="status-icon">‚úÖ</div>
                    <h4 id="statusTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
                    <p id="statusMessage" class="text-muted mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å Odoo...</p>
                    
                    <button onclick="resetScanner()" class="btn btn-primary btn-lg w-100">
                        ‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                    </button>
                </div>

            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    const scanSound = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3'); 
    let html5QrcodeScanner = null;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    document.addEventListener("DOMContentLoaded", () => {
        startScanner();
    });

    function startScanner() {
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('cameraSection').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('finalState').style.display = 'none';

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Scanner Instance ‡πÉ‡∏´‡∏°‡πà
        // ‡πÉ‡∏ä‡πâ html5-qrcode ‡πÅ‡∏ö‡∏ö Basic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£ Stop ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            false
        );
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
        // 1. ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        scanSound.play();

        // 2. ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        html5QrcodeScanner.clear().then(_ => {
            console.log("Camera stopped.");
            
            // 3. ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà Loading
            document.getElementById('cameraSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('scannedDataShow').innerText = `Code: ${decodedText}`;

            // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            sendToOdoo(decodedText);
        }).catch(error => {
            console.error("Failed to clear camera", error);
        });
    }

    function onScanFailure(error) {
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô
    }

    async function sendToOdoo(qrData) {
        const url = document.getElementById('odooUrl').value;
        
        // Payload ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏±‡∏ö Controller Odoo
        const payload = {
            jsonrpc: "2.0",
            method: "call",
            params: {
                qr_code: qrData,
                device_info: navigator.userAgent
            },
            id: Date.now()
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const data = await response.json();

            // ‡πÄ‡∏ä‡πá‡∏Ñ Error ‡∏à‡∏≤‡∏Å Odoo Logic
            if (data.error) {
                showResult(false, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Odoo", data.error.data.message || data.error.message);
            } else {
                // ‡πÄ‡∏ä‡πá‡∏Ñ Status ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å Python Controller (success/warning)
                const result = data.result; 
                if(result.status === 'success') {
                    showResult(true, "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", result.message);
                } else {
                    showResult(false, "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", result.message); // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                }
            }

        } catch (error) {
            console.error(error);
            showResult(false, "Connection Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Odoo Server ‡πÑ‡∏î‡πâ (CORS ‡∏´‡∏£‡∏∑‡∏≠ Network)");
        }
    }

    function showResult(isSuccess, title, message) {
        // ‡∏ã‡πà‡∏≠‡∏ô Loading -> ‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        document.getElementById('loadingState').style.display = 'none';
        const finalState = document.getElementById('finalState');
        finalState.style.display = 'block';

        // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á UI ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        const icon = document.getElementById('statusIcon');
        const titleElem = document.getElementById('statusTitle');
        
        if (isSuccess) {
            icon.innerHTML = "‚úÖ";
